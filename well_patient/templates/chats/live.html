

{% extends "base.html" %}
{% load admin_urls i18n unfold %}

{% block base %}
<div id="page" class="flex min-h-screen">
  {% if not is_popup and is_nav_sidebar_enabled %} {% block nav-sidebar %} 
  {%  include "admin/nav_sidebar.html" %} {% endblock %} {% endif %}

  <div id="main" class="flex-grow min-w-0" x-resize="mainWidth = $width">
    {% block content_before %}
     {% include "unfold/helpers/header.html" %}
     {%endblock %} {% if not is_popup %}
      {% spaceless %} 
      {% block breadcrumbs %}{%endblock %} 
      {% endspaceless %} {% endif %}

    <div class="px-4 lg:px-8">
      <div
        id="content"
        class="container mx-auto {% block coltype %}colM{% endblock %}"
      >
        {% block content %} {% block object-tools %}{% endblock %}
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="w-1/4 bg-white border-r border-gray-300">
        <!-- Sidebar Header -->
        <header class="p-4 border-b border-gray-300 flex justify-between items-center bg-primary-600 text-white">
            <h1 class="text-2xl font-semibold">Chat Web</h1>
        </header>

        <!-- Search and Filter Section -->
        <div class="p-4 border-b border-gray-300">
            <form method="get" class="flex flex-col gap-3">
                <!-- Search Box -->
                <div class="relative">
                    <input
                        type="text"
                        id="search"
                        name="search"
                        value="{{ request.GET.search|default:'' }}"
                        placeholder="Search by client ID"
                        class="border border-base-200 bg-white font-medium min-w-20 placeholder-base-400 rounded shadow-sm text-font-default-light text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none group-[.errors]:border-red-600 group-[.errors]:focus:ring-red-200 dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark dark:focus:border-primary-600 dark:focus:ring-primary-700 dark:focus:ring-opacity-50 dark:group-[.errors]:border-red-500 dark:group-[.errors]:focus:ring-red-600/40 px-3 py-2 w-full max-w-2xl"
                    />
                    <span class="absolute left-2 top-3 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </span>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="bg-primary-500 text-white px-4 py-2 rounded-md hover:bg-primary-600">
                    Apply Filters
                </button>
            </form>
        </div>

        <!-- Contact List -->
        <div class="overflow-y-auto h-screen p-3 mb-9 pb-20">
            {% for user in users %}
            <div 
                class="flex items-center mb-4 cursor-pointer hover:bg-gray-100 p-2 rounded-md {% if user.live %}bg-green-50 border-l-4 border-green-500{% endif %}"
                onclick="window.location.href='{% url 'admin:platform_chat' user.id %}'"
            >
                <div class="w-12 h-12 rounded-full mr-3 flex items-center justify-center bg-gray-200">
                    <span class="material-symbols-outlined text-gray-500">
                        person
                    </span>
                </div>
                <div class="flex-1">
                    <h2 class="text-lg font-semibold">{% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %} </h2>
                    <p class="text-gray-600 text-sm">
                        {% if user.last_message_time %}
                            {{ user.last_message_time|timesince }} ago
                        {% else %}
                            No messages yet
                        {% endif %}
                    </p>
                </div>
                {% if user.live %}
                <div class="ml-2">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        Live
                    </span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        {% if user %}
        <!-- Chat Header -->
        <header class="bg-white p-4 text-gray-700 border-b border-gray-300 flex justify-between items-center">
            <div class="flex items-center">
                <div class="w-10 h-10 rounded-full mr-3 flex items-center justify-center bg-gray-200">
                    <span class="material-symbols-outlined text-gray-500">
                        person
                    </span>
                </div>
                <h1 class="text-2xl font-semibold"> {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %} </h1>
                {% if user.live %}
                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    Live
                </span>
                {% endif %}
            </div>
            <button
                id="end-chat"
                type="button"
                class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg focus:outline-none focus:ring focus:ring-red-300">
                End Chat
            </button>
        </header>
        
        <!-- Chat Messages -->
        <div id="messages" class="flex-1 overflow-y-auto p-4 bg-gray-50">
            {% for message in messages %}
            <div class="chat-message mb-4">
                <div class="flex items-end {% if message.is_reply %}justify-end{% endif %}">
                    {% if not message.is_reply %}
                    <div class="w-8 h-8 rounded-full mr-2 flex items-center justify-center bg-gray-200">
                        <span class="material-symbols-outlined text-gray-500 text-sm">
                            person
                        </span>
                    </div>
                    {% endif %}
                    <div class="relative group">
                        <span class="px-4 py-2 rounded-lg inline-block {% if message.is_reply %}bg-primary-500 text-white rounded-br-none{% else %}bg-white text-gray-700 rounded-bl-none border border-gray-200{% endif %}">
                            {{ message.message }}
                        </span>
                        <div class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2 -bottom-6 {% if message.is_reply %}right-0{% else %}left-0{% endif %}">
                            {{ message.timestamp|date:"M j, H:i" }}
                        </div>
                    </div>
                    {% if message.is_reply %}
                    <div class="w-8 h-8 rounded-full ml-2 flex items-center justify-center bg-primary-100">
                        <span class="material-symbols-outlined text-primary-500 text-sm">
                            person
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Chat Input -->
<!-- Add this to your footer section -->
<footer class="bg-white border-t border-gray-300 p-4">
    <div class="flex items-center">
        <input
            type="text"
            id="chat-input"
            placeholder="Type a message..."
            class="flex-1 border border-base-200 bg-white font-medium min-w-20 placeholder-base-400 rounded shadow-sm text-font-default-light text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none group-[.errors]:border-red-600 group-[.errors]:focus:ring-red-200 dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark dark:focus:border-primary-600 dark:focus:ring-primary-700 dark:focus:ring-opacity-50 dark:group-[.errors]:border-red-500 dark:group-[.errors]:focus:ring-red-600/40 px-3 py-2"
        />
        <button
            id="send-button"
            class="bg-primary-500 text-white px-4 py-2 rounded-md ml-2 hover:bg-primary-600 flex items-center justify-center min-w-[80px]"
        >
            <span id="send-text">Send</span>
            <span id="sending-indicator" class="hidden ml-2">
                <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </span>
        </button>
    </div>
</footer>
        {% else %}
        <!-- Empty State -->
        <div class="flex-1 flex items-center justify-center bg-gray-50">
            <div class="text-center">
                <span class="material-symbols-outlined text-gray-400 text-6xl mb-4">
                    chat
                </span>
                <h2 class="text-xl font-semibold text-gray-700">Select a conversation</h2>
                <p class="text-gray-500 mt-2">Choose a user from the sidebar to start chatting</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% endblock %}

{% block extrastyle %}
<style>
    .scrollbar-w-2::-webkit-scrollbar {
        width: 0.25rem;
        height: 0.25rem;
    }
    .scrollbar-track-primary-lighter::-webkit-scrollbar-track {
        background-color: #f7fafc;
    }
    .scrollbar-thumb-primary::-webkit-scrollbar-thumb {
        background-color: #cbd5e0;
    }
    .scrollbar-thumb-rounded::-webkit-scrollbar-thumb {
        border-radius: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function scrollToBottom() {
        const messagesContainer = document.getElementById("messages");
        messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
        });
    }

    // Call this after adding new messages
    scrollToBottom();

    // Handle initial load
    window.addEventListener('load', () => {
        scrollToBottom();
    });

    document.getElementById("send-button").onclick = async function (event) {
        event.preventDefault();

        const inputField = document.getElementById("chat-input");
        const sendButton = document.getElementById("send-button");
        const sendText = document.getElementById("send-text");
        const sendingIndicator = document.getElementById("sending-indicator");

        const message = inputField.value.trim();
        if (message !== "") {
            // Show sending state
            sendText.textContent = "Sending";
            sendingIndicator.classList.remove("hidden");
            sendButton.disabled = true;

            try {
                const response = await fetch(`{% url "send_message" user.pk %}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    body: JSON.stringify({ message: message }),
                });

                if (response.ok) {
                    const data = await response.json();

                    // Add the message to the chat window
                    const messagesContainer = document.getElementById("messages");
                    const messageDiv = document.createElement("div");
                    messageDiv.className = "chat-message mb-4";

                    messageDiv.innerHTML = `
                        <div class="flex items-end justify-end">
                            <div class="relative group">
                                <span class="px-4 py-2 rounded-lg inline-block bg-primary-500 text-white rounded-br-none">
                                    ${message}
                                </span>
                                <div class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2 -bottom-6 right-0">
                                    Just now
                                </div>
                            </div>
                            <div class="w-8 h-8 rounded-full ml-2 flex items-center justify-center bg-primary-100">
                                <span class="material-symbols-outlined text-primary-500 text-sm">
                                    person
                                </span>
                            </div>
                        </div>
                    `;

                    messagesContainer.appendChild(messageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    inputField.value = ""; // Clear input
                } else {
                    console.error("Failed to send message:", response.statusText);
                }
            } catch (error) {
                console.error("Error sending message:", error);
            } finally {
                // Reset button state
                sendText.textContent = "Send";
                sendingIndicator.classList.add("hidden");
                sendButton.disabled = false;
            }
        }
    };

    document.getElementById("chat-input").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            document.getElementById("send-button").click();
        }
    });

    document.getElementById("end-chat").onclick = async function () {
        const response = await fetch('{% url "end_chat" %}', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ user_id: "{{ user.id }}" }),
        });

        if (response.ok) {
            alert("Live chat ended.");
        } else {
            alert("Failed to end chat.");
        }
    };
</script>
{% endblock %}