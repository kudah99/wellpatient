{% extends 'base.html' %} {% load i18n static unfold widget_tweaks %} 
{% block extra_head %}
<!-- Google Material Symbols and Font Awesome -->
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
/>
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
  rel="stylesheet"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>
{% endblock %}

{% block title %}
    {% if subtitle %}
        {{ subtitle }} |
    {% endif %}

    {{ title }} | {{ site_title|default:_('Django site admin') }}
{% endblock %}

{% block branding %}
    {% include "unfold/helpers/site_branding.html" %}
{% endblock %}
{% block base %}
<div id="page" class="flex min-h-screen">
  {% if not is_popup and is_nav_sidebar_enabled %} {% block nav-sidebar %} 
  {%  include "admin/nav_sidebar.html" %} {% endblock %} {% endif %}

  <div id="main" class="flex-grow min-w-0" x-resize="mainWidth = $width">
    {% block content_before %}
     {% include "unfold/helpers/header.html" %}
     {%endblock %} {% if not is_popup %}
      {% spaceless %} 
      {% block breadcrumbs %}{%endblock %} 
      {% endspaceless %} {% endif %}

    <div class="px-4 lg:px-8">
      <div
        id="content"
        class="container mx-auto {% block coltype %}colM{% endblock %}"
      >
        {% block content %} {% block object-tools %}{% endblock %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header section remains the same -->
    <div class="flex justify-between items-center mb-8">
        <!-- ... existing header code ... -->
    </div>

    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Broadcast Message Form</h3>
        </div>
        
        <div class="px-4 py-5 sm:p-6">
            <form method="post" class="space-y-8">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <!-- ... existing non-field errors code ... -->
                {% endif %}
                
                <!-- Message Details -->
                <div class="space-y-6">
                    <h4 class="text-lg font-medium text-gray-900">Message Details</h4>
                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        <div class="sm:col-span-4">
                            <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Title*</label>
                            <div class="mt-1">
                                {{ form.title|add_class:"border border-base-200 bg-white font-medium min-w-20 placeholder-base-400 rounded shadow-sm text-font-default-light text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none group-[.errors]:border-red-600 group-[.errors]:focus:ring-red-200 dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark dark:focus:border-primary-600 dark:focus:ring-primary-700 dark:focus:ring-opacity-50 dark:group-[.errors]:border-red-500 dark:group-[.errors]:focus:ring-red-600/40 px-3 py-2 w-full max-w-2xl " }}
                            </div>
                            {% if form.title.errors %}
                            <p class="mt-2 text-sm text-red-600">
                                {{ form.title.errors }}
                            </p>
                            {% endif %}
                        </div>

                        <div class="sm:col-span-2">
                            <label for="{{ form.broadcast_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Type*</label>
                            <div class="mt-1">
                                {{ form.broadcast_type|add_class:"border border-base-200 bg-white font-medium min-w-20 placeholder-base-400 rounded shadow-sm text-font-default-light text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none group-[.errors]:border-red-600 group-[.errors]:focus:ring-red-200 dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark dark:focus:border-primary-600 dark:focus:ring-primary-700 dark:focus:ring-opacity-50 dark:group-[.errors]:border-red-500 dark:group-[.errors]:focus:ring-red-600/40 px-3 py-2 w-full max-w-2xl " }}
                            </div>
                            {% if form.broadcast_type.errors %}
                            <p class="mt-2 text-sm text-red-600">
                                {{ form.broadcast_type.errors }}
                            </p>
                            {% endif %}
                        </div>

                        <div class="sm:col-span-6">
                            <label for="{{ form.message.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Message*</label>
                            <div class="mt-1">
                                {{ form.message|add_class:"border border-base-200 bg-white font-medium min-w-20 placeholder-base-400 rounded shadow-sm text-font-default-light text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none group-[.errors]:border-red-600 group-[.errors]:focus:ring-red-200 dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark dark:focus:border-primary-600 dark:focus:ring-primary-700 dark:focus:ring-opacity-50 dark:group-[.errors]:border-red-500 dark:group-[.errors]:focus:ring-red-600/40 px-3 py-2 w-full max-w-2xl "|attr:"rows:4" }}
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <p id="character-count" class="text-sm text-gray-500">0 characters</p>
                                <button type="button" id="preview-btn" class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                    Preview
                                </button>
                            </div>
                            {% if form.message.errors %}
                            <p class="mt-2 text-sm text-red-600">
                                {{ form.message.errors }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Delivery Options -->
                <div class="space-y-6">
                    <h4 class="text-lg font-medium text-gray-900">Delivery Options</h4>
                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        <div class="sm:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notification Channels*</label>
                            <div class="space-y-3">
                                <div class="relative flex items-start">
                                    <div class="flex h-5 items-center">
                                        {{ form.send_sms|add_class:"h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500" }}
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="{{ form.send_sms.id_for_label }}" class="font-medium text-gray-700">Send via SMS</label>
                                        <p class="text-gray-500">Message will be sent as text message</p>
                                    </div>
                                </div>
                                <div class="relative flex items-start">
                                    <div class="flex h-5 items-center">
                                        {{ form.send_whatsapp|add_class:"h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500" }}
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="{{ form.send_whatsapp.id_for_label }}" class="font-medium text-gray-700">Send via WhatsApp</label>
                                        <p class="text-gray-500">Message will be sent via WhatsApp</p>
                                    </div>
                                </div>
                            </div>
                            {% if form.send_sms.errors or form.send_whatsapp.errors %}
                            <p class="mt-2 text-sm text-red-600">
                                {{ form.send_sms.errors }}
                                {{ form.send_whatsapp.errors }}
                            </p>
                            {% endif %}
                        </div>

                        <div class="sm:col-span-3">
                            <label for="{{ form.scheduled_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Schedule Time</label>
                            <div class="mt-1">
                                {{ form.scheduled_time|add_class:"border border-base-200 bg-white font-medium min-w-20 placeholder-base-400 rounded shadow-sm text-font-default-light text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none group-[.errors]:border-red-600 group-[.errors]:focus:ring-red-200 dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark dark:focus:border-primary-600 dark:focus:ring-primary-700 dark:focus:ring-opacity-50 dark:group-[.errors]:border-red-500 dark:group-[.errors]:focus:ring-red-600/40 px-3 py-2 w-full max-w-2xl " }}
                            </div>
                            <p class="mt-2 text-sm text-gray-500">Leave empty to send immediately</p>
                            {% if form.scheduled_time.errors %}
                            <p class="mt-2 text-sm text-red-600">
                                {{ form.scheduled_time.errors }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Target Audience -->
                <div class="space-y-6">
                    <h4 class="text-lg font-medium text-gray-900">Target Audience</h4>
                    <p class="text-sm text-gray-500">Select locations to target specific areas. Leave empty to send to all locations.</p>
                    
                    <div class="sm:col-span-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Locations</label>
                        <div class="mt-1 p-3 border border-gray-300 rounded-md max-h-48 overflow-y-auto bg-gray-50">
                            <div class="space-y-3">
                                {% for checkbox in form.locations %}
                                <div class="flex items-center">
                                    {{ checkbox.tag }}
                                    <label for="{{ checkbox.id_for_label }}" class="ml-2 block text-sm text-gray-700">
                                        {{ checkbox.choice_label }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% if form.locations.errors %}
                        <p class="mt-2 text-sm text-red-600">
                            {{ form.locations.errors }}
                        </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="pt-6">
                    <div class="flex justify-end space-x-3">
                        <a href="{% url 'admin:broadcast_messages' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                            Cancel
                        </a>
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                            Send Broadcast
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preview Modal (same as before) -->
<div id="previewModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- ... existing modal code ... -->
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Character counter for message
        const messageArea = document.querySelector('#id_message');
        const charCount = document.querySelector('#character-count');
        
        if (messageArea && charCount) {
            // Update on load
            charCount.textContent = messageArea.value.length + ' characters';
            
            // Update on input
            messageArea.addEventListener('input', function() {
                const count = messageArea.value.length;
                charCount.textContent = count + ' characters';
                
                // Add warning if approaching SMS limit (160 chars)
                if (count > 140 && count <= 160) {
                    charCount.className = 'text-sm text-yellow-600';
                } else if (count > 160) {
                    charCount.className = 'text-sm text-red-600';
                } else {
                    charCount.className = 'text-sm text-gray-500';
                }
            });
        }

        // Preview functionality
        const previewBtn = document.querySelector('#preview-btn');
        const previewContainer = document.querySelector('#preview-message');
        
        if (previewBtn && previewContainer) {
            previewBtn.addEventListener('click', function() {
                const message = document.querySelector('#id_message').value;
                previewContainer.textContent = message || 'No message content';
                document.getElementById('previewModal').classList.remove('hidden');
            });
        }
    });
</script>
{% endblock %}
{% endblock %}